name: caselaw-daily-delta

on:
  repository_dispatch:
    types: [new-export]
  workflow_dispatch:
    inputs:
      export_url:
        description: "URL to decisions.json.gz export file"
        required: true
        type: string

jobs:
  daily:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      HF_DATASET_REPO: ${{ secrets.HF_DATASET_REPO }}
      CASELAW_ROLLING_SINCE_DAYS: ${{ vars.CASELAW_ROLLING_SINCE_DAYS }}
      LOG_LEVEL: INFO
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pipeline deps
        run: |
          python -m pip install --upgrade pip
          pip install -r pipeline/requirements.txt
          pip install -e pipeline

      - name: Download export
        run: |
          EXPORT_URL="${{ inputs.export_url || github.event.client_payload.export_url }}"
          if [ -z "$EXPORT_URL" ]; then
            echo "::error::No export_url provided. Supply it via workflow_dispatch input or repository_dispatch client_payload."
            exit 1
          fi
          mkdir -p data/exports
          curl -fSL --retry 3 --retry-delay 5 -o data/exports/decisions.json.gz "$EXPORT_URL"

      - name: Build delta
        run: |
          DATE="$(date -u +%F)"
          python -m caselaw_pipeline.cli build-delta --export data/exports/decisions.json.gz --out _build --date "$DATE" --parquet

      - name: Publish delta
        run: |
          DATE="$(date -u +%F)"
          python -m caselaw_pipeline.cli publish-delta --build-dir _build --date "$DATE" --parquet
