name: caselaw-weekly-consolidate

on:
  workflow_dispatch:
  schedule:
    - cron: "30 3 * * 0"  # weekly on Sunday 03:30 UTC

jobs:
  weekly:
    # For million+ docs, prefer a self-hosted runner with fast disk.
    runs-on: self-hosted
    timeout-minutes: 1440
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      HF_DATASET_REPO: ${{ secrets.HF_DATASET_REPO }}
      LOG_LEVEL: INFO
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pipeline deps
        run: |
          python -m pip install --upgrade pip
          pip install -r pipeline/requirements.txt
          pip install -e pipeline

      - name: Get current week
        id: week
        run: |
          WEEK=$(python -c "import datetime as dt; y,w,_=dt.date.today().isocalendar(); print(f'{y}-W{w:02d}')")
          echo "week=$WEEK" >> $GITHUB_OUTPUT

      - name: Consolidate weekly snapshot
        run: |
          python -m caselaw_pipeline.cli consolidate-weekly \
            --hf-repo "$HF_DATASET_REPO" \
            --build-dir _build \
            --week "${{ steps.week.outputs.week }}" \
            --parquet
