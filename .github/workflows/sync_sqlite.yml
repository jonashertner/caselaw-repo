name: Sync SQLite to HuggingFace

on:
  workflow_dispatch:

env:
  DATABASE_URL: postgresql+psycopg://postgres:postgres@localhost:5432/swisslaw
  PYTHONPATH: ${{ github.workspace }}/backend
  AGENT_TOOLSDIRECTORY: /Users/jonashertner/actions-runner/_work/_tool

jobs:
  sync-sqlite:
    runs-on: [self-hosted, swiss-caselaw]
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "$PWD/.venv/bin" >> $GITHUB_PATH

      - name: Generate statistics
        working-directory: ./backend
        run: |
          source .venv/bin/activate
          python -c "
          import sys
          sys.path.insert(0, '.')
          from sqlmodel import select, func
          from app.db.session import get_session
          from app.models.decision import Decision
          with get_session() as session:
              total = session.exec(select(func.count(Decision.id))).one()
              federal = session.exec(select(func.count(Decision.id)).where(Decision.level == 'federal')).one()
              cantonal = session.exec(select(func.count(Decision.id)).where(Decision.level == 'cantonal')).one()
          print(f'=== DATABASE STATISTICS ===')
          print(f'Total: {total:,}')
          print(f'Federal: {federal:,}')
          print(f'Cantonal: {cantonal:,}')
          "

      - name: Export SQLite database
        working-directory: ./backend
        run: |
          source .venv/bin/activate
          echo "Exporting PostgreSQL to SQLite..."
          python scripts/export_sqlite.py ../data/swisslaw.db
          ls -lh ../data/swisslaw.db

      - name: Push SQLite to HuggingFace
        working-directory: ./backend
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          source .venv/bin/activate
          echo "Pushing SQLite database to HuggingFace..."
          python scripts/push_sqlite_to_huggingface.py --sqlite ../data/swisslaw.db --repo voilaj/swiss-caselaw

      - name: Write summary
        run: |
          echo "## SQLite Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "SQLite database has been synced to voilaj/swiss-caselaw" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The HuggingFace Space will use this database on next restart." >> $GITHUB_STEP_SUMMARY
